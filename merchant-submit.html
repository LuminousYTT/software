<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>å•†æˆ·æäº¤å•†å“</title>
	<link rel="stylesheet" href="style.css" />
</head>

<body>
	<main class="container" style="padding: 2rem 0; max-width: 720px;">
		<h1 class="section-title">å•†æˆ·å•†å“ç®¡ç†</h1>
		<p style="margin-bottom: 1rem; color: #555;">å·²ç™»å½•å•†æˆ·å¯æäº¤ä¸Šæ¶æˆ–ä¸‹æ¶ç”³è¯·ï¼Œç®¡ç†å‘˜å®¡æ ¸åç”Ÿæ•ˆã€‚</p>
		<div class="card" style="margin-bottom:1rem;">
			<h3>æäº¤ä¸Šæ¶ç”³è¯·</h3>
			<form id="merchant-form">
				<div class="form-group">
					<label for="gname">å•†å“åç§°</label>
					<input id="gname" name="gname" type="text" placeholder="ä¾‹å¦‚ï¼šå’–å•¡åˆ¸" required />
				</div>
				<div class="form-row">
					<div class="form-group">
						<label for="gcount">æ•°é‡</label>
						<input id="gcount" name="gcount" type="number" min="1" step="1" placeholder="10" required />
					</div>
					<div class="form-group">
						<label for="gvalue">ä»·å€¼ï¼ˆç§¯åˆ†ï¼‰</label>
						<input id="gvalue" name="gvalue" type="number" min="1" step="1" placeholder="100" required />
					</div>
				</div>
				<button type="submit">æäº¤ä¸Šæ¶ç”³è¯·</button>
				<div id="merchant-tip" class="empty-tip hidden">æäº¤æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ã€‚</div>
			</form>
		</div>



		<div class="card" style="margin-top:1rem;">
			<h3>å·²ä¸Šæ¶å•†å“</h3>
			<div id="mine-list" class="shop-grid"></div>
			<div id="mine-empty" class="empty-tip hidden">æš‚æ— å·²ä¸Šæ¶å•†å“</div>
		</div>

		<div class="card">
			<h3>æäº¤ä¸‹æ¶ç”³è¯·</h3>
			<form id="offline-form">
				<div class="form-group">
					<label for="gid">å•†å“ID</label>
					<input id="gid" name="gid" type="number" min="1" step="1" placeholder="è¯·è¾“å…¥å·²ä¸Šæ¶å•†å“ID" required />
				</div>
				<button type="submit">æäº¤ä¸‹æ¶ç”³è¯·</button>
				<div id="offline-tip" class="empty-tip hidden">å·²æäº¤ä¸‹æ¶ç”³è¯·ï¼Œç­‰å¾…å®¡æ ¸ã€‚</div>
			</form>
		</div>
	</main>

	<script>
		function resolveApiBase() {
			const { protocol, hostname } = window.location;
			const safeProtocol = protocol.startsWith('http') ? protocol : 'http:';
			const host = hostname || '192.168.202.124';
			const port = 5000;
			return `${safeProtocol}//${host}:${port}/api`;
		}

		const API_BASE = resolveApiBase();
		const token = localStorage.getItem('merchant_token');
		if (!token) {
			window.location.href = 'merchant-auth.html';
		}

		const form = document.getElementById('merchant-form');
		const tip = document.getElementById('merchant-tip');
		const offlineForm = document.getElementById('offline-form');
		const offlineTip = document.getElementById('offline-tip');
		const mineList = document.getElementById('mine-list');
		const mineEmpty = document.getElementById('mine-empty');

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			const payload = {
				name: document.getElementById('gname').value.trim(),
				count: Number(document.getElementById('gcount').value),
				value: Number(document.getElementById('gvalue').value)
			};
			try {
				const res = await fetch(`${API_BASE}/merchant/submit`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
					body: JSON.stringify(payload)
				});
				const data = await res.json();
				if (!res.ok) throw new Error(data.error || 'æäº¤å¤±è´¥');
				tip.textContent = 'æäº¤æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ã€‚';
				tip.classList.remove('hidden');
				form.reset();
				await loadMine();
			} catch (err) {
				tip.textContent = err.message || 'æäº¤å¤±è´¥';
				tip.classList.remove('hidden');
			}
		});

		offlineForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const payload = { gid: Number(document.getElementById('gid').value) };
			try {
				const res = await fetch(`${API_BASE}/merchant/offline`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
					body: JSON.stringify(payload)
				});
				const data = await res.json();
				if (!res.ok) throw new Error(data.error || 'æäº¤å¤±è´¥');
				offlineTip.textContent = 'å·²æäº¤ä¸‹æ¶ç”³è¯·ï¼Œç­‰å¾…å®¡æ ¸ã€‚';
				offlineTip.classList.remove('hidden');
				offlineForm.reset();
				await loadMine();
			} catch (err) {
				offlineTip.textContent = err.message || 'æäº¤å¤±è´¥';
				offlineTip.classList.remove('hidden');
			}
		});

		async function loadMine() {
			try {
				const res = await fetch(`${API_BASE}/merchant/goods`, {
					headers: { 'Authorization': `Bearer ${token}` }
				});
				const data = await res.json();
				if (!res.ok) throw new Error(data.error || 'åŠ è½½å¤±è´¥');
				renderMine(data.items || []);
			} catch (err) {
				mineEmpty.textContent = err.message || 'åŠ è½½å¤±è´¥';
				mineEmpty.classList.remove('hidden');
			}
		}

		function renderMine(items) {
			mineList.innerHTML = '';
			if (!items.length) {
				mineEmpty.classList.remove('hidden');
				return;
			}
			mineEmpty.classList.add('hidden');
			items.forEach(item => {
				const card = document.createElement('div');
				card.className = 'product';
				card.innerHTML = `
					<div class="product-img">ğŸ·ï¸</div>
					<div class="product-info">
						<h4>${item.name || 'æœªå‘½åå•†å“'} (ID: ${item.id})</h4>
						<p>åº“å­˜ï¼š${item.count ?? 0}</p>
						<div class="price">ä»·å€¼ï¼š${item.value ?? 0} ç§¯åˆ†</div>
					</div>
				`;
				mineList.appendChild(card);
			});
		}

		loadMine();
	</script>
</body>

</html>