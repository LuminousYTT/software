<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>å¾…å®¡æ ¸å•†å“ç®¡ç†</title>
	<link rel="stylesheet" href="style.css" />
</head>

<body>
	<main class="container" style="padding: 2rem 0; max-width: 900px;">
		<h1 class="section-title">å¾…å®¡æ ¸å•†å“ç®¡ç†</h1>
		<div class="card">
			<div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
				<div>å®¡æ ¸é€šè¿‡åï¼Œå•†å“æ‰ä¼šä¸Šæ¶åˆ°ç§¯åˆ†å•†åŸã€‚</div>
				<button id="admin-logout" class="btn-link" type="button"
					style="color:#2e7d32; border-color:#2e7d32;">é€€å‡º</button>
			</div>
			<div id="pending-list" class="shop-grid"></div>
			<div id="pending-empty" class="empty-tip">æš‚æ— å¾…å®¡æ ¸å•†å“</div>
		</div>
	</main>

	<script>
		function resolveApiBase() {
			const { protocol, hostname } = window.location;
			const safeProtocol = protocol.startsWith('http') ? protocol : 'http:';
			const host = hostname || '192.168.202.124';
			const port = 5000;
			return `${safeProtocol}//${host}:${port}/api`;
		}

		const API_BASE = resolveApiBase(); // éœ€åç«¯å®ç° /admin/goods æ¥å£
		const listEl = document.getElementById('pending-list');
		const emptyEl = document.getElementById('pending-empty');
		const token = localStorage.getItem('admin_token');

		if (!token) {
			window.location.href = 'admin-login.html';
		}

		document.getElementById('admin-logout').addEventListener('click', () => {
			localStorage.removeItem('admin_token');
			window.location.href = 'admin-login.html';
		});

		listEl.addEventListener('click', async (e) => {
			const btn = e.target.closest('button[data-action]');
			if (!btn) return;
			const id = btn.dataset.id;
			const action = btn.dataset.action; // approve / reject
			try {
				const res = await fetch(`${API_BASE}/admin/goods/${action}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${token}`
					},
					body: JSON.stringify({ id })
				});
				const data = await res.json();
				if (!res.ok) throw new Error(data.error || 'æ“ä½œå¤±è´¥');
				await loadPending();
			} catch (err) {
				alert(err.message || 'æ“ä½œå¤±è´¥');
			}
		});

		async function loadPending() {
			try {
				const res = await fetch(`${API_BASE}/admin/goods/pending`, {
					headers: { 'Authorization': `Bearer ${token}` }
				});
				const data = await res.json();
				if (!res.ok) throw new Error(data.error || 'åŠ è½½å¤±è´¥');
				renderList(data.items || []);
			} catch (err) {
				emptyEl.textContent = err.message || 'åŠ è½½å¤±è´¥';
				emptyEl.classList.remove('hidden');
			}
		}

		function renderList(items) {
			listEl.innerHTML = '';
			if (!items.length) {
				emptyEl.classList.remove('hidden');
				return;
			}
			emptyEl.classList.add('hidden');
			items.forEach(item => {
				const card = document.createElement('div');
				card.className = 'product';
				const actionText = item.action === 'offline' ? 'ä¸‹æ¶ç”³è¯·' : 'ä¸Šæ¶ç”³è¯·';
				const targetText = item.action === 'offline' ? `ç›®æ ‡å•†å“IDï¼š${item.targetGid || '-'}
` : '';
				card.innerHTML = `
                    <div class="product-img">ğŸ“¦</div>
                    <div class="product-info">
                        <h4>${item.name || 'æœªå‘½åå•†å“'} <span style="font-size:0.9rem;color:#2e7d32;">(${actionText})</span></h4>
                        <p>å•†æˆ·ï¼š${item.sid || '-'} ${targetText}</p>
                        <p>æ•°é‡ï¼š${item.count ?? 0}</p>
                        <div class="price">ä»·å€¼ï¼š${item.value ?? 0} ç§¯åˆ†</div>
                        <div style="display:flex; gap: 0.5rem; margin-top: 0.8rem;">
                            <button class="redeem-btn" data-action="approve" data-id="${item.id}">é€šè¿‡</button>
                            <button class="btn-link" data-action="reject" data-id="${item.id}" style="color:#e53935; border-color:#e53935;">é©³å›</button>
                        </div>
                    </div>
                `;
				listEl.appendChild(card);
			});
		}

		loadPending();
	</script>
</body>

</html>